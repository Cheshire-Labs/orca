system:
    name: "smc-assay"
    version: "0.0.1"
    description: "SMC Assay Example"

labwares:
    sample-plate:
        type: "Matrix 96 Well"
    plate-1:
        type: "Corning 96 Well"
    final-plate:
        type: "SMC 384 plate"
    bead-reservoir:
        type: "reservoir"
        static: true
    buffer-b-reservoir:
        type: "reservoir"
        static: true
    buffer-d-reservoir:
        type: "reservoir"
        static: true
    detection-reservoir:
        type: "reservoir"
        static: true
    tips-96:
        type: "96 Tips"
    tips-384:
        type: "384 Tips"

resources:
    biotek-1:
        type: biotek
        com: "COM3"
        plate-pad: "biotek_1"
    biotek-2:
        type: biotek
        com: "COM4"
        plate-pad: "biotek_2"
    bravo-96-head:
        type: bravo
        ip: 192.168.1.123
        head: 96
        plate-pad: "bravo_96"
        initial-deck:
            1: bead-reservoir
            2: detection-reservoir
            6: waste
    bravo-384-head:
        type: bravo
        ip: 192.168.1.124
        head: 384
        plate-pad: "bravo_384"
        initial-deck:
            1: buffer-b-reservoir
            2: buffer-d-reservoir
            6: waste
    sealer:
        type: plateloc
        com: "COM7"
    centrifuge:
        type: vspin
        com: "COM8"
    plate-hotel:
        type: agilent-hotel
    smc-pro:
        type: smc-pro
        ip: 192.168.1.122
        plate-pad: "smc_pro"

## ROBOTICS
    ddr-1:
        type: mock-robot
        ip: 192.168.1.125
        positions: 
            - biotek_1
            - bravo_96
            - translator_1_start
            - waste_1

    ddr-2:
        type: mock-robot
        ip: 192.168.1.126
        positions: 
            - centrifuge
            - sealer
            - translator_1_end
            - translater_2_start
            - stacker_1
            - stacker_2
            - stacker_3
            - stacker_4
            - stacker_5
            - stacker_6
            - stacker_7
            - shaker_1
            - shaker_2
            - shaker_3
            - shaker_4
            - shaker_5
            - shaker_6
            - shaker_7
            - shaker_8
            - shaker_9
            - shaker_10
    ddr-3:
        type: mock-robot
        ip: 192.168.1.127
        positions: 
            - biotek_2
            - bravo_384
            - plate_hotel
            - smc_pro
            - translater_2_end
            - waste_2

    translator-1:
        type: translator
        com: "COM5"
        positions: 
            - translator_1_start
            - translator_1_end
    translater-2:
        type: translator
        com: "COM6"
        positions:
            - translater_2_start
            - translater_2_end


## STACKERS
    stacker-sample-start:
        type: vstack
        ip: 192.168.1.121
        plate-pad: stacker_1
        init:
            labware: ${sample-plate.type}
    stacker-sample-end:
        type: vstack
        ip: 192.168.1.122
        plate-pad: stacker_2
        init:
            labware: ${sample-plate.type}
    stacker-plate-1-start:
        type: vstack
        ip: 192.168.1.123
        plate-pad: stacker_3
        init:
            labware: "Corning 96 Well"
    stacker-final-plate-start:
        type: vstack
        ip: 192.168.1.124
        plate-pad: stacker_4
        init:
            labware: ${final-plate.type}
    stacker-96-tips:
        type: vstack
        ip: 192.168.1.125
        plate-pad: stacker_5
        init:
            labware: ${tips-96.type}
    stacker-384-tips-start:
        type: vstack
        ip: 192.168.1.126
        plate-pad: stacker_6
        init:
            labware: ${tips-384.type}
    stacker-384-tips-end:
        type: vstack
        ip: 192.168.1.127
        plate-pad: stacker_7
        init:
            labware: ${tips-384.type}

## SHAKERS
    shaker-1:
        type: shaker
        com: "COM9"
    shaker-2:
        type: shaker
        com: "COM10"
    shaker-3:
        type: shaker
        com: "COM11"
    shaker-4:
        type: shaker
        com: "COM12"
    shaker-5:
        type: shaker
        com: "COM13"
    shaker-6:
        type: shaker
        com: "COM14"
    shaker-7:
        type: shaker
        com: "COM15"
    shaker-8:
        type: shaker
        com: "COM16"
    shaker-9:
        type: shaker
        com: "COM17"
    shaker-10:
        type: shaker
        com: "COM18"

## WASTE
    waste-1:
        type: waste
    waste-2:
        type: waste
    

## NETWORKING
    serial-switch:
        type: serial-switch
        ip: 192.168.0.1
    splitter:
        type: switch
        ip: 192.168.0.2

## RESOURCE POOLS
    shaker-collection:
        type: pool 
        resources: [shaker-1, shaker-2, shaker-3, shaker-4, shaker-5, shaker-6, shaker-7, shaker-8, shaker-9, shaker-10]
    
    waste-collection:
        type: pool 
        resources: [waste-1, waste-2]

config:
    prod:
        settle-time: 120
        bead-incubation-time: 7200
        post-detection-incubate-time: 3600
        post-detection-settle-time: 600
    test:
        settle-time: 0
        bead-incubation-time: 0
        post-detection-incubate-time: 0
        post-detection-settle-time: 0



methods:
    sample-to-bead-plate:
        actions:
            - bravo-96-head:
                command: run
                inputs: [sample-plate, tips-96, plate-1]
                deck-setup:
                    4: 96-tips
                    5: sample-plate
                    9: plate-1
                protocol: sample-to-bead-plate.pro

    incubate-2hrs:
      actions:
        - shaker-collection:
            command: shake
            inputs: [plate-1]
            shake-time: ${config.{param}.bead-incubation-time}

    post-capture-wash:
      actions:
        - biotek-1:
            command: run
            inputs: [plate-1]
            protocol: post-capture-wash.pro

    add-detection-antibody:
      actions:
        - bravo-96-head:
            command: run
            inputs: [plate-1, tips-96]
            deck-setup:
                4: tips-96
                5: plate-1
            protocol: add-detection-antibody.pro

    incubate-1-hr:
      actions:
        - shaker-collection:
            command: shake
            inputs: [plate-1]
            shake-time: ${config.{param}.post-detection-incubate-time}

    pre-transfer-wash:
      actions:
        - biotek-2:
            command: run
            inputs: [plate-1]
            protocol: pre-transfer-wash.pro

    discard-supernatant:
        actions:
            - biotek-2:
                command: run
                inputs: [plate-1]
                protocol: discard-supernatant.pro

    add-elution-buffer-b:
        actions:
            - bravo-384-head:
                command: run
                inputs: [plate-1, buffer-b-reservoir]
                deck-setup:
                    1: buffer-b-reservoir
                    9: plate-1
                protocol: add-elution-buffer-b.pro

    incubate-10-min:
        actions:
            - shaker-1:
                command: shake
                inputs: [plate-1]
                shake-time: ${config.{param}.post-detection-settle-time}

    add-buffer-d:
        actions:
            - bravo-384-head:
                command: run
                inputs: [plate-1]
                deck-setup:
                    9: plate-1
                protocol: add-buffer-d.pro

    combine-plates:
        actions:
            - bravo-384-head:
                command: run
                inputs: [final-plate, plate-1, tips-384]
                ratio: 
                    final-plate: 1
                    plate-1: 4
                protocol: combine-plates.pro
        
    transfer-eluate:
        scripts:
            pre-execution: "transfer-eluate.py"
        actions:
            - bravo-384-head:
                command: run
                inputs: [final-plate, tips-384]
                protocol: transfer-eluate.pro

    centrifuge:
        actions:
            - centrifuge:
                command: spin
                inputs: [final-plate]
                speed: 2000
                time: 120
    read:
        actions:
            - smc_pro:
                command: read
                inputs: [final-plate]
                protocol: read.pro
                filepath: "results.csv"


workflows:
    smc-assay:
        sample-plate:
            start: stacker-sample-start
            end: stacker-sample-end
            steps:
                - sample-to-bead-plate

        plate-1:
            start: stacker-plate-1-start
            end: waste-1
            steps:
                - sample-to-bead-plate
                - incubate-2hrs
                - post-capture-wash
                - add-detection-antibody
                - incubate-1-hr
                - pre-transfer-wash
                - discard-supernatant
                - add-elution-buffer-b
                - incubate-10-min
                - add-buffer-d
                - combine-plates
                - centrifuge
                - read
              
        final-plate:
            start: stacker-final-plate-start
            end: plate-hotel
            steps:
                - combine-plates
                - transfer-eluate
                - centrifuge
                - read
        

## SCRIPT EXAMPLES
scripts:
    get-positions: 
        script: get-positions.py:get-positions(${0}, ${1})

    worklist-iter: 
        source: file-row-iterator("worklist.csv") 
        mapping:
            src: "source"
            dest: "destination"
            vol: "volume"
            liq-class: "liquid_class_name"

    api-worklist-iter: 
        source: http-get("http://api.com/worklist") 
        mapping:
            src: "source"
            dest: "destination"
            vol: "volume"

    id-iter: 
        source: file-row-iterator("ids.txt") 
        mapping:
            id: "id"

    fed-api-worklist-iter: 
        worklist-source: http-get("http://api.com/get-volume/{id-iter.id}") 
        mapping:
            src: "source"
            dest: "destination"
            vol: "volume"